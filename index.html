<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Marmoraria</title>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos Gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c3e50; /* Azul Escuro */
            --secondary-color: #3498db; /* Azul Claro */
            --accent-color: #e74c3c; /* Vermelho */
            --light-color: #ecf0f1; /* Cinza Claro */
            --dark-color: #2c3e50;
            --success-color: #2ecc71; /* Verde */
            --warning-color: #f39c12; /* Laranja */
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        h1 {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 1.8rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        /* Botões */
        .btn {
            display: inline-flex; /* Para alinhar ícone e texto */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Espaço entre ícone e texto */
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn i {
            font-size: 1.1em; /* Tamanho do ícone */
        }

        .primary-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .primary-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .secondary-btn {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid #ccc;
        }

        .secondary-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .delete-btn {
            background-color: transparent;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .delete-btn:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.05);
        }

        .edit-btn {
            background-color: transparent;
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
            padding: 6px 12px;
            font-size: 0.9rem;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background-color: var(--warning-color);
            color: white;
            transform: scale(1.05);
        }

        /* Formulários */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .error-message {
            color: var(--danger-color);
            margin-top: 5px;
            font-size: 0.9rem;
        }

        /* Login */
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            padding: 20px;
        }

        .login-form {
            background-color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-form h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            border-bottom: none;
            justify-content: center;
        }

        .login-form .btn {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
        }

        .sales-message {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 25px;
            text-align: left;
            font-size: 0.95rem;
            color: var(--primary-color);
        }

        .sales-message strong {
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Layout Principal */
        #main-content {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }

        nav {
            background-color: var(--secondary-color);
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav ul {
            display: flex;
            list-style: none;
            overflow-x: auto;
            padding: 5px 0;
        }

        nav li {
            margin-right: 5px;
        }

        nav a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            white-space: nowrap;
            border-radius: var(--border-radius);
        }

        nav a:hover,
        nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        main {
            flex: 1;
            padding: 20px;
            background-color: #f4f7f6;
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px;
            margin-top: auto;
        }

        /* Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 5px solid var(--secondary-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .count {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .dashboard-alerts {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        /* Listas */
        .form-container, .list-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .list-item {
            background-color: #ffffff;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 3px 7px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
            position: relative;
            border-left: 4px solid var(--info-color);
        }

        .list-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .list-item h4 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-item p {
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #555;
        }

        .list-item p strong {
            color: var(--dark-color);
            margin-right: 5px;
        }

        .list-item .actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }

        .empty-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
            color: #777;
            font-style: italic;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Alertas (Lista na página de Alertas) */
        .alert-item {
            border-left-width: 5px;
        }
        .alert-item.high {
            border-left-color: var(--danger-color);
        }
        .alert-item.medium {
            border-left-color: var(--warning-color);
        }
        .alert-item.low {
            border-left-color: var(--info-color);
        }
        .alert-item h4 {
            color: var(--primary-color);
        }

        /* Popup de Alerta */
        #alert-popup-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .alert-popup {
            background-color: white;
            color: var(--dark-color);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards;
            border-left: 5px solid;
        }

        .alert-popup.high {
            border-left-color: var(--danger-color);
        }
        .alert-popup.medium {
            border-left-color: var(--warning-color);
        }
        .alert-popup.low {
            border-left-color: var(--info-color);
        }

        .alert-popup i {
            font-size: 1.5rem;
        }
        .alert-popup.high i { color: var(--danger-color); }
        .alert-popup.medium i { color: var(--warning-color); }
        .alert-popup.low i { color: var(--info-color); }

        .alert-popup-content p {
            margin: 0;
            font-size: 0.9rem;
        }
        .alert-popup-content strong {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .alert-popup-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: auto;
            padding: 5px;
        }
        .alert-popup-close:hover {
            color: #555;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Utilitários */
        .hidden {
            display: none !important;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            .list {
                grid-template-columns: 1fr;
            }
            nav ul {
                flex-wrap: nowrap;
            }
            nav a {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            h1 {
                font-size: 1.8rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            #alert-popup-container {
                right: 10px;
                bottom: 10px;
                left: 10px;
                max-width: none;
            }
            .alert-popup {
                min-width: auto;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .form-container, .list-container {
                padding: 15px;
            }
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            header h1 {
                font-size: 1.2rem;
            }
            .login-form {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Container de Login -->
    <div id="login-container" class="container">
        <div class="login-form">
            <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
            <div class="sales-message">
                <i class="fas fa-info-circle"></i> Acesse todas as funcionalidades e otimize a gestão da sua marmoraria!
                <br><strong>Plano mensal: R$ 99,00</strong>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Seu email">
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Sua senha">
            </div>
            <p id="login-error" class="error-message"></p>
            <button id="login-btn" class="btn primary-btn"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            <button id="register-btn" class="btn secondary-btn"><i class="fas fa-user-plus"></i> Registrar Nova Conta</button>
        </div>
    </div>

    <!-- Conteúdo Principal (após login) -->
    <div id="main-content" class="hidden">
        <header>
            <h1><i class="fas fa-cogs"></i> Sistema de Gerenciamento</h1>
            <button id="logout-btn" class="btn secondary-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </header>

        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="maquinas"><i class="fas fa-industry"></i> Máquinas</a></li>
                <li><a href="#" class="nav-link" data-page="operacoes"><i class="fas fa-tasks"></i> Operações</a></li>
                <li><a href="#" class="nav-link" data-page="pecas"><i class="fas fa-puzzle-piece"></i> Peças</a></li>
                <li><a href="#" class="nav-link" data-page="manutencoes"><i class="fas fa-tools"></i> Manutenções</a></li>
                <li><a href="#" class="nav-link" data-page="alertas"><i class="fas fa-bell"></i> Alertas</a></li>
            </ul>
        </nav>

        <main>
            <!-- Dashboard -->
            <section id="dashboard" class="page">
                <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
                <div class="dashboard-cards">
                    <div class="card">
                        <h3><i class="fas fa-industry"></i> Máquinas</h3>
                        <p id="maquinas-count" class="count">0</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-tasks"></i> Operações</h3>
                        <p id="operacoes-count" class="count">0</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-puzzle-piece"></i> Peças</h3>
                        <p id="pecas-count" class="count">0</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-tools"></i> Manutenções</h3>
                        <p id="manutencoes-count" class="count">0</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-bell"></i> Alertas Ativos</h3>
                        <p id="alertas-count" class="count">0</p>
                    </div>
                </div>

                <div class="dashboard-alerts list-container">
                    <h3><i class="fas fa-exclamation-triangle"></i> Alertas Recentes</h3>
                    <div id="alertas-recentes-list" class="list">
                        <p class="empty-message">Nenhum alerta recente.</p>
                    </div>
                </div>
            </section>

            <!-- Máquinas -->
            <section id="maquinas" class="page hidden">
                <h2><i class="fas fa-industry"></i> Gerenciamento de Máquinas</h2>
                
                <div class="form-container">
                    <h3><i class="fas fa-plus-circle"></i> Cadastrar/Editar Máquina</h3>
                    <input type="hidden" id="maquina-edit-id">
                    <div class="form-group">
                        <label for="maquina-nome">Nome:</label>
                        <input type="text" id="maquina-nome" placeholder="Nome da máquina">
                    </div>
                    <div class="form-group">
                        <label for="maquina-modelo">Modelo:</label>
                        <input type="text" id="maquina-modelo" placeholder="Modelo da máquina">
                    </div>
                    <div class="form-group">
                        <label for="maquina-fabricante">Fabricante:</label>
                        <input type="text" id="maquina-fabricante" placeholder="Fabricante da máquina">
                    </div>
                    <div class="form-group">
                        <label for="maquina-data-aquisicao">Data de Aquisição:</label>
                        <input type="date" id="maquina-data-aquisicao">
                    </div>
                    <div class="form-group">
                        <label for="maquina-status">Status:</label>
                        <select id="maquina-status">
                            <option value="Ativa">Ativa</option>
                            <option value="Em Manutenção">Em Manutenção</option>
                            <option value="Desativada">Desativada</option>
                        </select>
                    </div>
                    <button id="maquina-salvar" class="btn primary-btn"><i class="fas fa-save"></i> Salvar</button>
                    <button id="maquina-cancelar" class="btn secondary-btn hidden"><i class="fas fa-times"></i> Cancelar Edição</button>
                </div>

                <div class="list-container">
                    <h3><i class="fas fa-list"></i> Máquinas Cadastradas</h3>
                    <div id="maquinas-list" class="list">
                        <p class="empty-message">Nenhuma máquina cadastrada.</p>
                    </div>
                </div>
            </section>

            <!-- Operações -->
            <section id="operacoes" class="page hidden">
                <h2><i class="fas fa-tasks"></i> Registro de Operações</h2>
                
                <div class="form-container">
                    <h3><i class="fas fa-plus-circle"></i> Registrar/Editar Operação</h3>
                    <input type="hidden" id="operacao-edit-id">
                    <div class="form-group">
                        <label for="operacao-maquina">Máquina:</label>
                        <select id="operacao-maquina">
                            <option value="">Selecione uma máquina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operacao-tipo">Tipo de Operação:</label>
                        <input type="text" id="operacao-tipo" placeholder="Ex: Corte, Polimento">
                    </div>
                    <div class="form-group">
                        <label for="operacao-data">Data:</label>
                        <input type="date" id="operacao-data">
                    </div>
                    <div class="form-group">
                        <label for="operacao-duracao">Duração (horas):</label>
                        <input type="number" id="operacao-duracao" min="0" step="0.1" placeholder="Duração em horas">
                    </div>
                    <div class="form-group">
                        <label for="operacao-operador">Operador:</label>
                        <input type="text" id="operacao-operador" placeholder="Nome do operador">
                    </div>
                    <div class="form-group">
                        <label for="operacao-observacoes">Observações:</label>
                        <textarea id="operacao-observacoes" placeholder="Observações sobre a operação"></textarea>
                    </div>
                    <button id="operacao-salvar" class="btn primary-btn"><i class="fas fa-save"></i> Salvar</button>
                    <button id="operacao-cancelar" class="btn secondary-btn hidden"><i class="fas fa-times"></i> Cancelar Edição</button>
                </div>

                <div class="list-container">
                    <h3><i class="fas fa-list"></i> Operações Registradas</h3>
                    <div id="operacoes-list" class="list">
                        <p class="empty-message">Nenhuma operação registrada.</p>
                    </div>
                </div>
            </section>

            <!-- Peças -->
            <section id="pecas" class="page hidden">
                <h2><i class="fas fa-puzzle-piece"></i> Cadastro de Peças</h2>
                
                <div class="form-container">
                    <h3><i class="fas fa-plus-circle"></i> Cadastrar/Editar Peça</h3>
                    <input type="hidden" id="peca-edit-id">
                    <div class="form-group">
                        <label for="peca-nome">Nome:</label>
                        <input type="text" id="peca-nome" placeholder="Nome da peça">
                    </div>
                    <div class="form-group">
                        <label for="peca-codigo">Código:</label>
                        <input type="text" id="peca-codigo" placeholder="Código da peça">
                    </div>
                    <div class="form-group">
                        <label for="peca-maquina">Máquina Compatível:</label>
                        <select id="peca-maquina">
                            <option value="">Selecione uma máquina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="peca-vida-util">Vida Útil (horas):</label>
                        <input type="number" id="peca-vida-util" min="0" placeholder="Vida útil estimada em horas">
                    </div>
                    <div class="form-group">
                        <label for="peca-ultima-troca">Data da Última Troca:</label>
                        <input type="date" id="peca-ultima-troca">
                    </div>
                    <div class="form-group">
                        <label for="peca-estoque">Quantidade em Estoque:</label>
                        <input type="number" id="peca-estoque" min="0" placeholder="Quantidade em estoque">
                    </div>
                    <button id="peca-salvar" class="btn primary-btn"><i class="fas fa-save"></i> Salvar</button>
                    <button id="peca-cancelar" class="btn secondary-btn hidden"><i class="fas fa-times"></i> Cancelar Edição</button>
                </div>

                <div class="list-container">
                    <h3><i class="fas fa-list"></i> Peças Cadastradas</h3>
                    <div id="pecas-list" class="list">
                        <p class="empty-message">Nenhuma peça cadastrada.</p>
                    </div>
                </div>
            </section>

            <!-- Manutenções -->
            <section id="manutencoes" class="page hidden">
                <h2><i class="fas fa-tools"></i> Registro de Manutenções</h2>
                
                <div class="form-container">
                    <h3><i class="fas fa-plus-circle"></i> Registrar/Editar Manutenção</h3>
                    <input type="hidden" id="manutencao-edit-id">
                    <div class="form-group">
                        <label for="manutencao-maquina">Máquina:</label>
                        <select id="manutencao-maquina">
                            <option value="">Selecione uma máquina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manutencao-tipo">Tipo de Manutenção:</label>
                        <select id="manutencao-tipo">
                            <option value="Preventiva">Preventiva</option>
                            <option value="Corretiva">Corretiva</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manutencao-data">Data:</label>
                        <input type="date" id="manutencao-data">
                    </div>
                    <div class="form-group">
                        <label for="manutencao-responsavel">Responsável:</label>
                        <input type="text" id="manutencao-responsavel" placeholder="Nome do responsável">
                    </div>
                    <div class="form-group">
                        <label for="manutencao-descricao">Descrição:</label>
                        <textarea id="manutencao-descricao" placeholder="Descrição detalhada da manutenção"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="manutencao-custo">Custo (R$):</label>
                        <input type="number" id="manutencao-custo" min="0" step="0.01" placeholder="Custo em reais">
                    </div>
                    <button id="manutencao-salvar" class="btn primary-btn"><i class="fas fa-save"></i> Salvar</button>
                    <button id="manutencao-cancelar" class="btn secondary-btn hidden"><i class="fas fa-times"></i> Cancelar Edição</button>
                </div>

                <div class="list-container">
                    <h3><i class="fas fa-list"></i> Manutenções Registradas</h3>
                    <div id="manutencoes-list" class="list">
                        <p class="empty-message">Nenhuma manutenção registrada.</p>
                    </div>
                </div>
            </section>

            <!-- Alertas -->
            <section id="alertas" class="page hidden">
                <h2><i class="fas fa-bell"></i> Sistema de Alertas</h2>
                
                <div class="list-container full-width">
                    <h3><i class="fas fa-exclamation-triangle"></i> Alertas Ativos</h3>
                    <div id="alertas-list" class="list">
                        <p class="empty-message">Nenhum alerta ativo.</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Sistema de Gerenciamento de Marmoraria</p>
        </footer>
    </div>

    <!-- Popup de Alerta Container -->
    <div id="alert-popup-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            getDoc,
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc,
            query,
            where,
            orderBy,
            limit,
            Timestamp // Importar Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Configuração do Firebase (Substitua pelas suas credenciais)
        const firebaseConfig = {
            apiKey: "AIzaSyA1FPchcsdsyJWmOZUqfdbm-EbwkF01Awc",
    authDomain: "controle-4b27d.firebaseapp.com",
    projectId: "controle-4b27d",
    storageBucket: "controle-4b27d.firestorage.app",
    messagingSenderId: "194889796690",
    appId: "1:194889796690:web:c3162d4193252454fee38b"
  };

        // Inicializar Firebase, Auth e Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referências para as coleções
        const maquinasCollection = collection(db, 'maquinas');
        const operacoesCollection = collection(db, 'operacoes');
        const pecasCollection = collection(db, 'pecas');
        const manutencoesCollection = collection(db, 'manutencoes');
        const alertasCollection = collection(db, 'alertas');

        // Verificar se o Firebase está inicializado corretamente
        console.log("Firebase inicializado:", app.name);
        console.log("Auth disponível:", !!auth);
        console.log("Firestore disponível:", !!db);

        // --- Elementos do DOM --- 
        // Login
        const loginContainer = document.getElementById('login-container');
        const mainContent = document.getElementById('main-content');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        // Navegação
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        // Dashboard
        const maquinasCount = document.getElementById('maquinas-count');
        const operacoesCount = document.getElementById('operacoes-count');
        const pecasCount = document.getElementById('pecas-count');
        const manutencoesCount = document.getElementById('manutencoes-count');
        const alertasCount = document.getElementById('alertas-count');
        const alertasRecentesList = document.getElementById('alertas-recentes-list');
        // Máquinas
        const maquinaForm = document.querySelector('#maquinas .form-container');
        const maquinaEditIdInput = document.getElementById('maquina-edit-id');
        const maquinaNome = document.getElementById('maquina-nome');
        const maquinaModelo = document.getElementById('maquina-modelo');
        const maquinaFabricante = document.getElementById('maquina-fabricante');
        const maquinaDataAquisicao = document.getElementById('maquina-data-aquisicao');
        const maquinaStatus = document.getElementById('maquina-status');
        const maquinaSalvar = document.getElementById('maquina-salvar');
        const maquinaCancelar = document.getElementById('maquina-cancelar');
        const maquinasList = document.getElementById('maquinas-list');
        // Operações
        const operacaoForm = document.querySelector('#operacoes .form-container');
        const operacaoEditIdInput = document.getElementById('operacao-edit-id');
        const operacaoMaquina = document.getElementById('operacao-maquina');
        const operacaoTipo = document.getElementById('operacao-tipo');
        const operacaoData = document.getElementById('operacao-data');
        const operacaoDuracao = document.getElementById('operacao-duracao');
        const operacaoOperador = document.getElementById('operacao-operador');
        const operacaoObservacoes = document.getElementById('operacao-observacoes');
        const operacaoSalvar = document.getElementById('operacao-salvar');
        const operacaoCancelar = document.getElementById('operacao-cancelar');
        const operacoesList = document.getElementById('operacoes-list');
        // Peças
        const pecaForm = document.querySelector('#pecas .form-container');
        const pecaEditIdInput = document.getElementById('peca-edit-id');
        const pecaNome = document.getElementById('peca-nome');
        const pecaCodigo = document.getElementById('peca-codigo');
        const pecaMaquina = document.getElementById('peca-maquina');
        const pecaVidaUtil = document.getElementById('peca-vida-util');
        const pecaUltimaTroca = document.getElementById('peca-ultima-troca');
        const pecaEstoque = document.getElementById('peca-estoque');
        const pecaSalvar = document.getElementById('peca-salvar');
        const pecaCancelar = document.getElementById('peca-cancelar');
        const pecasList = document.getElementById('pecas-list');
        // Manutenções
        const manutencaoForm = document.querySelector('#manutencoes .form-container');
        const manutencaoEditIdInput = document.getElementById('manutencao-edit-id');
        const manutencaoMaquina = document.getElementById('manutencao-maquina');
        const manutencaoTipo = document.getElementById('manutencao-tipo');
        const manutencaoData = document.getElementById('manutencao-data');
        const manutencaoResponsavel = document.getElementById('manutencao-responsavel');
        const manutencaoDescricao = document.getElementById('manutencao-descricao');
        const manutencaoCusto = document.getElementById('manutencao-custo');
        const manutencaoSalvar = document.getElementById('manutencao-salvar');
        const manutencaoCancelar = document.getElementById('manutencao-cancelar');
        const manutencoesList = document.getElementById('manutencoes-list');
        // Alertas
        const alertasList = document.getElementById('alertas-list');
        const alertPopupContainer = document.getElementById('alert-popup-container');

        // --- Autenticação --- 
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuário logado:", user.email);
                loginContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                carregarDados(); // Carregar dados após login
            } else {
                console.log("Nenhum usuário logado.");
                loginContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                loginError.textContent = 'Por favor, preencha todos os campos.';
                return;
            }
            loginError.textContent = '';
            try {
                console.log("Tentando fazer login com:", email);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Erro no login:", error);
                loginError.textContent = `Erro no login: ${getFirebaseErrorMessage(error)}`;
            }
        });

        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                loginError.textContent = 'Por favor, preencha todos os campos para registrar.';
                return;
            }
            if (password.length < 6) {
                loginError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                return;
            }
            loginError.textContent = '';
            try {
                console.log("Tentando registrar com:", email);
                await createUserWithEmailAndPassword(auth, email, password);
                mostrarPopupAlerta('Conta registrada com sucesso! Você já está logado.', 'low');
            } catch (error) {
                console.error("Erro no registro:", error);
                loginError.textContent = `Erro no registro: ${getFirebaseErrorMessage(error)}`;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Logout bem-sucedido.");
            } catch (error) {
                console.error("Erro no logout:", error);
                mostrarPopupAlerta("Erro ao fazer logout.", 'high');
            }
        });

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Formato de email inválido.';
                case 'auth/user-disabled':
                    return 'Este usuário foi desabilitado.';
                case 'auth/user-not-found':
                    return 'Usuário não encontrado.';
                case 'auth/wrong-password':
                    return 'Senha incorreta.';
                case 'auth/email-already-in-use':
                    return 'Este email já está em uso.';
                case 'auth/weak-password':
                    return 'Senha muito fraca.';
                default:
                    return error.message;
            }
        }

        // --- Navegação --- 
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                pages.forEach(page => page.classList.add('hidden'));
                const pageId = this.getAttribute('data-page');
                document.getElementById(pageId).classList.remove('hidden');
            });
        });

        // --- Funções CRUD --- 
        // Função principal para carregar todos os dados
        async function carregarDados() {
            console.log("Carregando dados do Firebase...");
            try {
                await carregarMaquinas();
                await carregarOperacoes();
                await carregarPecas();
                await carregarManutencoes();
                await carregarAlertas();
                await atualizarDashboard();
                console.log("Todos os dados carregados com sucesso!");
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                mostrarPopupAlerta("Ocorreu um erro ao carregar os dados. Verifique o console.", 'high');
            }
        }

        // Máquinas
        async function carregarMaquinas() {
            console.log("Carregando máquinas...");
            try {
                const snapshot = await getDocs(maquinasCollection);
                maquinasList.innerHTML = ''; // Limpar lista
                if (snapshot.empty) {
                    maquinasList.innerHTML = '<p class="empty-message">Nenhuma máquina cadastrada.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const maquina = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('list-item');
                        item.dataset.id = doc.id;
                        item.innerHTML = `
                            <h4><i class="fas fa-industry"></i> ${maquina.nome}</h4>
                            <p><strong>Modelo:</strong> ${maquina.modelo}</p>
                            <p><strong>Fabricante:</strong> ${maquina.fabricante}</p>
                            <p><strong>Aquisição:</strong> ${formatarData(maquina.dataAquisicao)}</p>
                            <p><strong>Status:</strong> ${maquina.status}</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="window.editarMaquina('${doc.id}')"><i class="fas fa-edit"></i> Editar</button>
                                <button class="delete-btn" onclick="window.excluirMaquina('${doc.id}')"><i class="fas fa-trash-alt"></i> Excluir</button>
                            </div>
                        `;
                        maquinasList.appendChild(item);
                    });
                }
                await atualizarSelectsMaquinas();
            } catch (error) {
                console.error("Erro ao carregar máquinas:", error);
                maquinasList.innerHTML = '<p class="empty-message">Erro ao carregar máquinas.</p>';
            }
        }

        async function atualizarSelectsMaquinas() {
            const selects = [operacaoMaquina, pecaMaquina, manutencaoMaquina];
            selects.forEach(select => {
                if (select) select.innerHTML = '<option value="">Selecione uma máquina</option>';
            });
            try {
                const snapshot = await getDocs(maquinasCollection);
                snapshot.forEach(doc => {
                    const maquina = doc.data();
                    const option = `<option value="${doc.id}">${maquina.nome}</option>`;
                    selects.forEach(select => {
                        if (select) select.innerHTML += option;
                    });
                });
            } catch (error) {
                console.error("Erro ao atualizar selects de máquinas:", error);
            }
        }

        maquinaSalvar.addEventListener('click', async () => {
            const nome = maquinaNome.value.trim();
            const modelo = maquinaModelo.value.trim();
            const fabricante = maquinaFabricante.value.trim();
            const dataAquisicao = maquinaDataAquisicao.value;
            const status = maquinaStatus.value;
            const editId = maquinaEditIdInput.value;

            if (!nome || !modelo || !fabricante || !dataAquisicao) {
                mostrarPopupAlerta('Por favor, preencha todos os campos obrigatórios.', 'medium');
                return;
            }

            const maquinaData = {
                nome, modelo, fabricante, dataAquisicao, status,
                dataCadastro: Timestamp.now() // Usar Timestamp
            };

            try {
                if (editId) {
                    const docRef = doc(db, 'maquinas', editId);
                    await updateDoc(docRef, maquinaData);
                    mostrarPopupAlerta('Máquina atualizada com sucesso!', 'low');
                } else {
                    await addDoc(maquinasCollection, maquinaData);
                    mostrarPopupAlerta('Máquina adicionada com sucesso!', 'low');
                }
                limparFormularioMaquina();
                await carregarMaquinas();
                await atualizarDashboard();
            } catch (error) {
                console.error("Erro ao salvar máquina:", error);
                mostrarPopupAlerta('Erro ao salvar máquina: ' + error.message, 'high');
            }
        });

        maquinaCancelar.addEventListener('click', limparFormularioMaquina);

        function limparFormularioMaquina() {
            maquinaForm.reset();
            maquinaEditIdInput.value = '';
            maquinaSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar';
            maquinaCancelar.classList.add('hidden');
        }

        window.editarMaquina = async (id) => {
            try {
                const docRef = doc(db, 'maquinas', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const maquina = docSnap.data();
                    maquinaEditIdInput.value = id;
                    maquinaNome.value = maquina.nome;
                    maquinaModelo.value = maquina.modelo;
                    maquinaFabricante.value = maquina.fabricante;
                    maquinaDataAquisicao.value = maquina.dataAquisicao;
                    maquinaStatus.value = maquina.status;
                    maquinaSalvar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                    maquinaCancelar.classList.remove('hidden');
                    maquinaForm.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar máquina para edição:", error);
            }
        };

        window.excluirMaquina = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta máquina?')) {
                try {
                    await deleteDoc(doc(db, 'maquinas', id));
                    mostrarPopupAlerta('Máquina excluída com sucesso!', 'low');
                    await carregarMaquinas();
                    await atualizarDashboard();
                } catch (error) {
                    console.error("Erro ao excluir máquina:", error);
                    mostrarPopupAlerta('Erro ao excluir máquina.', 'high');
                }
            }
        };

        // Operações
        async function carregarOperacoes() {
            console.log("Carregando operações...");
            try {
                const snapshot = await getDocs(operacoesCollection);
                operacoesList.innerHTML = ''; // Limpar lista
                if (snapshot.empty) {
                    operacoesList.innerHTML = '<p class="empty-message">Nenhuma operação registrada.</p>';
                } else {
                    snapshot.forEach(async (doc) => {
                        const operacao = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('list-item');
                        item.dataset.id = doc.id;
                        const maquinaNome = await getNomeMaquina(operacao.maquinaId);
                        item.innerHTML = `
                            <h4><i class="fas fa-cogs"></i> ${operacao.tipo}</h4>
                            <p><strong>Máquina:</strong> ${maquinaNome}</p>
                            <p><strong>Data:</strong> ${formatarData(operacao.data)}</p>
                            <p><strong>Duração:</strong> ${operacao.duracao} horas</p>
                            <p><strong>Operador:</strong> ${operacao.operador}</p>
                            <p><strong>Obs:</strong> ${operacao.observacoes || 'Nenhuma'}</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="window.editarOperacao('${doc.id}')"><i class="fas fa-edit"></i> Editar</button>
                                <button class="delete-btn" onclick="window.excluirOperacao('${doc.id}')"><i class="fas fa-trash-alt"></i> Excluir</button>
                            </div>
                        `;
                        operacoesList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar operações:", error);
                operacoesList.innerHTML = '<p class="empty-message">Erro ao carregar operações.</p>';
            }
        }

        operacaoSalvar.addEventListener('click', async () => {
            const maquinaId = operacaoMaquina.value;
            const tipo = operacaoTipo.value.trim();
            const data = operacaoData.value;
            const duracao = operacaoDuracao.value;
            const operador = operacaoOperador.value.trim();
            const observacoes = operacaoObservacoes.value.trim();
            const editId = operacaoEditIdInput.value;

            if (!maquinaId || !tipo || !data || !duracao || !operador) {
                mostrarPopupAlerta('Por favor, preencha todos os campos obrigatórios.', 'medium');
                return;
            }

            const operacaoData = {
                maquinaId, tipo, data, duracao: parseFloat(duracao), operador, observacoes,
                dataCadastro: Timestamp.now()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'operacoes', editId), operacaoData);
                    mostrarPopupAlerta('Operação atualizada com sucesso!', 'low');
                } else {
                    await addDoc(operacoesCollection, operacaoData);
                    mostrarPopupAlerta('Operação adicionada com sucesso!', 'low');
                }
                limparFormularioOperacao();
                await carregarOperacoes();
                await atualizarDashboard();
                await verificarAlertasPecas(); // Recalcular alertas de peças após nova operação
            } catch (error) {
                console.error("Erro ao salvar operação:", error);
                mostrarPopupAlerta('Erro ao salvar operação: ' + error.message, 'high');
            }
        });

        operacaoCancelar.addEventListener('click', limparFormularioOperacao);

        function limparFormularioOperacao() {
            operacaoForm.reset();
            operacaoEditIdInput.value = '';
            operacaoSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar';
            operacaoCancelar.classList.add('hidden');
        }

        window.editarOperacao = async (id) => {
            try {
                const docRef = doc(db, 'operacoes', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const operacao = docSnap.data();
                    operacaoEditIdInput.value = id;
                    operacaoMaquina.value = operacao.maquinaId;
                    operacaoTipo.value = operacao.tipo;
                    operacaoData.value = operacao.data;
                    operacaoDuracao.value = operacao.duracao;
                    operacaoOperador.value = operacao.operador;
                    operacaoObservacoes.value = operacao.observacoes || '';
                    operacaoSalvar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                    operacaoCancelar.classList.remove('hidden');
                    operacaoForm.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar operação para edição:", error);
            }
        };

        window.excluirOperacao = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta operação?')) {
                try {
                    await deleteDoc(doc(db, 'operacoes', id));
                    mostrarPopupAlerta('Operação excluída com sucesso!', 'low');
                    await carregarOperacoes();
                    await atualizarDashboard();
                    await verificarAlertasPecas(); // Recalcular alertas de peças
                } catch (error) {
                    console.error("Erro ao excluir operação:", error);
                    mostrarPopupAlerta('Erro ao excluir operação.', 'high');
                }
            }
        };

        // Peças
        async function carregarPecas() {
            console.log("Carregando peças...");
            try {
                const snapshot = await getDocs(pecasCollection);
                pecasList.innerHTML = ''; // Limpar lista
                if (snapshot.empty) {
                    pecasList.innerHTML = '<p class="empty-message">Nenhuma peça cadastrada.</p>';
                } else {
                    snapshot.forEach(async (doc) => {
                        const peca = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('list-item');
                        item.dataset.id = doc.id;
                        const maquinaNome = await getNomeMaquina(peca.maquinaId);
                        item.innerHTML = `
                            <h4><i class="fas fa-puzzle-piece"></i> ${peca.nome} (${peca.codigo})</h4>
                            <p><strong>Máquina:</strong> ${maquinaNome}</p>
                            <p><strong>Vida Útil:</strong> ${peca.vidaUtil} horas</p>
                            <p><strong>Última Troca:</strong> ${formatarData(peca.ultimaTroca)}</p>
                            <p><strong>Estoque:</strong> ${peca.estoque} unidades</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="window.editarPeca('${doc.id}')"><i class="fas fa-edit"></i> Editar</button>
                                <button class="delete-btn" onclick="window.excluirPeca('${doc.id}')"><i class="fas fa-trash-alt"></i> Excluir</button>
                            </div>
                        `;
                        pecasList.appendChild(item);
                    });
                }
                await verificarAlertasPecas(); // Verificar alertas após carregar
            } catch (error) {
                console.error("Erro ao carregar peças:", error);
                pecasList.innerHTML = '<p class="empty-message">Erro ao carregar peças.</p>';
            }
        }

        pecaSalvar.addEventListener('click', async () => {
            const nome = pecaNome.value.trim();
            const codigo = pecaCodigo.value.trim();
            const maquinaId = pecaMaquina.value;
            const vidaUtil = pecaVidaUtil.value;
            const ultimaTroca = pecaUltimaTroca.value;
            const estoque = pecaEstoque.value;
            const editId = pecaEditIdInput.value;

            if (!nome || !codigo || !maquinaId || !vidaUtil || !ultimaTroca || !estoque) {
                mostrarPopupAlerta('Por favor, preencha todos os campos obrigatórios.', 'medium');
                return;
            }

            const pecaData = {
                nome, codigo, maquinaId, vidaUtil: parseInt(vidaUtil), ultimaTroca, estoque: parseInt(estoque),
                dataCadastro: Timestamp.now()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'pecas', editId), pecaData);
                    mostrarPopupAlerta('Peça atualizada com sucesso!', 'low');
                } else {
                    await addDoc(pecasCollection, pecaData);
                    mostrarPopupAlerta('Peça adicionada com sucesso!', 'low');
                }
                limparFormularioPeca();
                await carregarPecas();
                await atualizarDashboard();
            } catch (error) {
                console.error("Erro ao salvar peça:", error);
                mostrarPopupAlerta('Erro ao salvar peça: ' + error.message, 'high');
            }
        });

        pecaCancelar.addEventListener('click', limparFormularioPeca);

        function limparFormularioPeca() {
            pecaForm.reset();
            pecaEditIdInput.value = '';
            pecaSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar';
            pecaCancelar.classList.add('hidden');
        }

        window.editarPeca = async (id) => {
            try {
                const docRef = doc(db, 'pecas', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const peca = docSnap.data();
                    pecaEditIdInput.value = id;
                    pecaNome.value = peca.nome;
                    pecaCodigo.value = peca.codigo;
                    pecaMaquina.value = peca.maquinaId;
                    pecaVidaUtil.value = peca.vidaUtil;
                    pecaUltimaTroca.value = peca.ultimaTroca;
                    pecaEstoque.value = peca.estoque;
                    pecaSalvar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                    pecaCancelar.classList.remove('hidden');
                    pecaForm.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar peça para edição:", error);
            }
        };

        window.excluirPeca = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta peça?')) {
                try {
                    await deleteDoc(doc(db, 'pecas', id));
                    mostrarPopupAlerta('Peça excluída com sucesso!', 'low');
                    await carregarPecas();
                    await atualizarDashboard();
                } catch (error) {
                    console.error("Erro ao excluir peça:", error);
                    mostrarPopupAlerta('Erro ao excluir peça.', 'high');
                }
            }
        };

        // Manutenções
        async function carregarManutencoes() {
            console.log("Carregando manutenções...");
            try {
                const snapshot = await getDocs(manutencoesCollection);
                manutencoesList.innerHTML = ''; // Limpar lista
                if (snapshot.empty) {
                    manutencoesList.innerHTML = '<p class="empty-message">Nenhuma manutenção registrada.</p>';
                } else {
                    snapshot.forEach(async (doc) => {
                        const manutencao = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('list-item');
                        item.dataset.id = doc.id;
                        const maquinaNome = await getNomeMaquina(manutencao.maquinaId);
                        item.innerHTML = `
                            <h4><i class="fas fa-tools"></i> Manutenção ${manutencao.tipo}</h4>
                            <p><strong>Máquina:</strong> ${maquinaNome}</p>
                            <p><strong>Data:</strong> ${formatarData(manutencao.data)}</p>
                            <p><strong>Responsável:</strong> ${manutencao.responsavel}</p>
                            <p><strong>Descrição:</strong> ${manutencao.descricao || 'Nenhuma'}</p>
                            <p><strong>Custo:</strong> R$ ${parseFloat(manutencao.custo).toFixed(2)}</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="window.editarManutencao('${doc.id}')"><i class="fas fa-edit"></i> Editar</button>
                                <button class="delete-btn" onclick="window.excluirManutencao('${doc.id}')"><i class="fas fa-trash-alt"></i> Excluir</button>
                            </div>
                        `;
                        manutencoesList.appendChild(item);
                    });
                }
                await verificarAlertasManutencoes(); // Verificar alertas após carregar
            } catch (error) {
                console.error("Erro ao carregar manutenções:", error);
                manutencoesList.innerHTML = '<p class="empty-message">Erro ao carregar manutenções.</p>';
            }
        }

        manutencaoSalvar.addEventListener('click', async () => {
            const maquinaId = manutencaoMaquina.value;
            const tipo = manutencaoTipo.value;
            const data = manutencaoData.value;
            const responsavel = manutencaoResponsavel.value.trim();
            const descricao = manutencaoDescricao.value.trim();
            const custo = manutencaoCusto.value;
            const editId = manutencaoEditIdInput.value;

            if (!maquinaId || !tipo || !data || !responsavel || !custo) {
                mostrarPopupAlerta('Por favor, preencha todos os campos obrigatórios.', 'medium');
                return;
            }

            const manutencaoData = {
                maquinaId, tipo, data, responsavel, descricao, custo: parseFloat(custo),
                dataCadastro: Timestamp.now()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'manutencoes', editId), manutencaoData);
                    mostrarPopupAlerta('Manutenção atualizada com sucesso!', 'low');
                } else {
                    await addDoc(manutencoesCollection, manutencaoData);
                    mostrarPopupAlerta('Manutenção adicionada com sucesso!', 'low');
                }
                limparFormularioManutencao();
                await carregarManutencoes();
                await atualizarDashboard();
            } catch (error) {
                console.error("Erro ao salvar manutenção:", error);
                mostrarPopupAlerta('Erro ao salvar manutenção: ' + error.message, 'high');
            }
        });

        manutencaoCancelar.addEventListener('click', limparFormularioManutencao);

        function limparFormularioManutencao() {
            manutencaoForm.reset();
            manutencaoEditIdInput.value = '';
            manutencaoSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar';
            manutencaoCancelar.classList.add('hidden');
        }

        window.editarManutencao = async (id) => {
            try {
                const docRef = doc(db, 'manutencoes', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const manutencao = docSnap.data();
                    manutencaoEditIdInput.value = id;
                    manutencaoMaquina.value = manutencao.maquinaId;
                    manutencaoTipo.value = manutencao.tipo;
                    manutencaoData.value = manutencao.data;
                    manutencaoResponsavel.value = manutencao.responsavel;
                    manutencaoDescricao.value = manutencao.descricao || '';
                    manutencaoCusto.value = manutencao.custo;
                    manutencaoSalvar.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
                    manutencaoCancelar.classList.remove('hidden');
                    manutencaoForm.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar manutenção para edição:", error);
            }
        };

        window.excluirManutencao = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta manutenção?')) {
                try {
                    await deleteDoc(doc(db, 'manutencoes', id));
                    mostrarPopupAlerta('Manutenção excluída com sucesso!', 'low');
                    await carregarManutencoes();
                    await atualizarDashboard();
                } catch (error) {
                    console.error("Erro ao excluir manutenção:", error);
                    mostrarPopupAlerta('Erro ao excluir manutenção.', 'high');
                }
            }
        };

        // Alertas
        async function carregarAlertas() {
            console.log("Carregando alertas...");
            try {
                const snapshot = await getDocs(query(alertasCollection, orderBy("data", "desc")));
                alertasList.innerHTML = ''; // Limpar lista
                alertasRecentesList.innerHTML = ''; // Limpar lista de recentes
                let alertasAtivos = 0;
                let alertasRecentesCount = 0;

                if (snapshot.empty) {
                    alertasList.innerHTML = '<p class="empty-message">Nenhum alerta ativo.</p>';
                    alertasRecentesList.innerHTML = '<p class="empty-message">Nenhum alerta recente.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const alerta = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('list-item', 'alert-item', alerta.prioridade.toLowerCase());
                        item.dataset.id = doc.id;
                        item.innerHTML = `
                            <h4><i class="fas fa-exclamation-triangle"></i> ${alerta.titulo}</h4>
                            <p><strong>Descrição:</strong> ${alerta.descricao}</p>
                            <p><strong>Data:</strong> ${formatarData(alerta.data)}</p>
                            <p><strong>Prioridade:</strong> ${alerta.prioridade}</p>
                            <div class="actions">
                                <button class="delete-btn" onclick="window.resolverAlerta('${doc.id}')"><i class="fas fa-check-circle"></i> Resolver</button>
                            </div>
                        `;
                        alertasList.appendChild(item);
                        alertasAtivos++;

                        // Adicionar aos recentes no dashboard
                        if (alertasRecentesCount < 3) {
                            const recenteItem = item.cloneNode(true);
                            alertasRecentesList.appendChild(recenteItem);
                            alertasRecentesCount++;
                        }
                    });
                    if (alertasRecentesCount === 0) {
                         alertasRecentesList.innerHTML = '<p class="empty-message">Nenhum alerta recente.</p>';
                    }
                }
                // Atualizar contador de alertas no dashboard
                if (alertasCount) alertasCount.textContent = alertasAtivos;

            } catch (error) {
                console.error("Erro ao carregar alertas:", error);
                alertasList.innerHTML = '<p class="empty-message">Erro ao carregar alertas.</p>';
                alertasRecentesList.innerHTML = '<p class="empty-message">Erro ao carregar alertas recentes.</p>';
            }
        }

        window.resolverAlerta = async (id) => {
            if (confirm('Marcar este alerta como resolvido?')) {
                try {
                    await deleteDoc(doc(db, 'alertas', id));
                    mostrarPopupAlerta('Alerta resolvido com sucesso!', 'low');
                    await carregarAlertas(); // Recarrega a lista de alertas na página e no dashboard
                    // O contador no dashboard será atualizado pelo carregarAlertas
                } catch (error) {
                    console.error("Erro ao resolver alerta:", error);
                    mostrarPopupAlerta('Erro ao resolver alerta.', 'high');
                }
            }
        };

        // Lógica de Geração de Alertas (Aprimorada)
        async function verificarAlertasPecas() {
            console.log("Verificando alertas de peças...");
            try {
                const pecasSnapshot = await getDocs(pecasCollection);
                const maquinasMap = await getMaquinasMap(); // Cache de nomes de máquinas

                for (const pecaDoc of pecasSnapshot.docs) {
                    const peca = pecaDoc.data();
                    const pecaId = pecaDoc.id;
                    const maquinaNome = maquinasMap[peca.maquinaId] || 'Desconhecida';

                    // 1. Alerta de Vida Útil
                    const horasUso = await calcularHorasUsoReal(peca.maquinaId, peca.ultimaTroca);
                    const vidaUtil = parseInt(peca.vidaUtil);
                    const percentualUso = vidaUtil > 0 ? (horasUso / vidaUtil) * 100 : 0;
                    const limiteTroca = 80; // 80% da vida útil

                    const alertaVidaUtilQuery = query(alertasCollection, where('tipo', '==', 'peca_vida_util'), where('referenciaId', '==', pecaId));
                    const alertaVidaUtilSnapshot = await getDocs(alertaVidaUtilQuery);

                    if (percentualUso >= limiteTroca) {
                        if (alertaVidaUtilSnapshot.empty) {
                            const prioridade = percentualUso >= 100 ? 'Alta' : 'Média';
                            const titulo = `Troca de Peça: ${peca.nome} (${maquinaNome})`;
                            const descricao = `A peça ${peca.nome} (${peca.codigo}) na máquina ${maquinaNome} atingiu ${percentualUso.toFixed(0)}% (${horasUso.toFixed(1)}h) da sua vida útil (${vidaUtil}h). Considere programar a substituição.`;
                            await criarAlerta('peca_vida_util', pecaId, titulo, descricao, prioridade);
                        }
                    } else {
                        // Remover alerta existente se a condição não for mais atendida
                        if (!alertaVidaUtilSnapshot.empty) {
                            await deleteDoc(alertaVidaUtilSnapshot.docs[0].ref);
                            console.log(`Alerta de vida útil removido para peça ${pecaId}`);
                        }
                    }

                    // 2. Alerta de Estoque Baixo
                    const estoque = parseInt(peca.estoque);
                    const limiteEstoque = 2; // Ex: alertar quando <= 2

                    const alertaEstoqueQuery = query(alertasCollection, where('tipo', '==', 'peca_estoque'), where('referenciaId', '==', pecaId));
                    const alertaEstoqueSnapshot = await getDocs(alertaEstoqueQuery);

                    if (estoque <= limiteEstoque) {
                        if (alertaEstoqueSnapshot.empty) {
                            const prioridade = estoque === 0 ? 'Alta' : 'Média';
                            const titulo = `Estoque Baixo: ${peca.nome}`;
                            const descricao = `O estoque da peça ${peca.nome} (${peca.codigo}) está baixo (${estoque} unidades). Considere adquirir mais unidades.`;
                            await criarAlerta('peca_estoque', pecaId, titulo, descricao, prioridade);
                        }
                    } else {
                        // Remover alerta existente se a condição não for mais atendida
                        if (!alertaEstoqueSnapshot.empty) {
                            await deleteDoc(alertaEstoqueSnapshot.docs[0].ref);
                            console.log(`Alerta de estoque removido para peça ${pecaId}`);
                        }
                    }
                }
                await carregarAlertas(); // Atualizar lista de alertas após verificações
            } catch (error) {
                console.error("Erro ao verificar alertas de peças:", error);
            }
        }

        async function verificarAlertasManutencoes() {
            console.log("Verificando alertas de manutenções...");
            try {
                const maquinasSnapshot = await getDocs(maquinasCollection);
                const hoje = new Date();
                const limiteDias = 90; // Ex: alertar após 90 dias

                for (const maquinaDoc of maquinasSnapshot.docs) {
                    const maquinaId = maquinaDoc.id;
                    const maquina = maquinaDoc.data();

                    // Consultar a última manutenção preventiva
                    const manutencaoQuery = query(
                        manutencoesCollection,
                        where('maquinaId', '==', maquinaId),
                        where('tipo', '==', 'Preventiva'),
                        orderBy('data', 'desc'),
                        limit(1)
                    );
                    const manutencaoSnapshot = await getDocs(manutencaoQuery);

                    let diasDesdeUltimaManutencao = Infinity;
                    if (!manutencaoSnapshot.empty) {
                        const ultimaManutencao = manutencaoSnapshot.docs[0].data();
                        const dataUltimaManutencao = new Date(ultimaManutencao.data + 'T00:00:00'); // Considerar início do dia
                        diasDesdeUltimaManutencao = Math.floor((hoje - dataUltimaManutencao) / (1000 * 60 * 60 * 24));
                    }

                    const alertaManutencaoQuery = query(alertasCollection, where('tipo', '==', 'manutencao_preventiva'), where('referenciaId', '==', maquinaId));
                    const alertaManutencaoSnapshot = await getDocs(alertaManutencaoQuery);

                    if (diasDesdeUltimaManutencao >= limiteDias) {
                        if (alertaManutencaoSnapshot.empty) {
                            const prioridade = diasDesdeUltimaManutencao >= 120 ? 'Alta' : 'Média';
                            const titulo = `Manutenção Preventiva: ${maquina.nome}`;
                            const descricao = manutencaoSnapshot.empty
                                ? `A máquina ${maquina.nome} nunca passou por manutenção preventiva. Recomenda-se agendar.`
                                : `A máquina ${maquina.nome} está há ${diasDesdeUltimaManutencao} dias sem manutenção preventiva. Recomenda-se agendar.`;
                            await criarAlerta('manutencao_preventiva', maquinaId, titulo, descricao, prioridade);
                        }
                    } else {
                        // Remover alerta existente se a condição não for mais atendida
                        if (!alertaManutencaoSnapshot.empty) {
                            await deleteDoc(alertaManutencaoSnapshot.docs[0].ref);
                            console.log(`Alerta de manutenção removido para máquina ${maquinaId}`);
                        }
                    }
                }
                await carregarAlertas(); // Atualizar lista de alertas após verificações
            } catch (error) {
                console.error("Erro ao verificar alertas de manutenção:", error);
            }
        }

        async function criarAlerta(tipo, referenciaId, titulo, descricao, prioridade) {
            try {
                const alertaData = {
                    tipo,
                    referenciaId,
                    titulo,
                    descricao,
                    prioridade, // 'Alta', 'Média', 'Baixa'
                    data: new Date().toISOString().split('T')[0],
                    resolvido: false,
                    dataCriacao: Timestamp.now()
                };
                await addDoc(alertasCollection, alertaData);
                console.log(`Alerta criado: ${titulo}`);
                mostrarPopupAlerta(`${titulo}: ${descricao}`, prioridade.toLowerCase());
            } catch (error) {
                console.error("Erro ao criar alerta:", error);
            }
        }

        // Função para calcular horas de uso REAL de uma máquina desde uma data
        async function calcularHorasUsoReal(maquinaId, dataInicioStr) {
            if (!dataInicioStr) return 0; // Se não há data de início, não há uso
            try {
                const dataInicio = new Date(dataInicioStr + 'T00:00:00');
                const operacoesQuery = query(
                    operacoesCollection,
                    where('maquinaId', '==', maquinaId),
                    where('data', '>=', dataInicioStr) // Comparar strings de data YYYY-MM-DD
                );
                const operacoesSnapshot = await getDocs(operacoesQuery);
                let horasTotal = 0;
                operacoesSnapshot.forEach(doc => {
                    horasTotal += parseFloat(doc.data().duracao) || 0;
                });
                console.log(`Horas de uso calculadas para máquina ${maquinaId} desde ${dataInicioStr}: ${horasTotal}`);
                return horasTotal;
            } catch (error) {
                console.error(`Erro ao calcular horas de uso real para máquina ${maquinaId}:`, error);
                return 0; // Retornar 0 em caso de erro
            }
        }

        // --- Funções Auxiliares --- 
        async function getNomeMaquina(maquinaId) {
            if (!maquinaId) return 'N/A';
            try {
                const docRef = doc(db, 'maquinas', maquinaId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().nome : 'Máquina não encontrada';
            } catch (error) {
                console.error("Erro ao buscar nome da máquina:", error);
                return 'Erro';
            }
        }

        async function getMaquinasMap() {
            const map = {};
            try {
                const snapshot = await getDocs(maquinasCollection);
                snapshot.forEach(doc => {
                    map[doc.id] = doc.data().nome;
                });
            } catch (error) {
                console.error("Erro ao criar mapa de máquinas:", error);
            }
            return map;
        }

        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            try {
                // Tenta criar data considerando que pode ser string YYYY-MM-DD ou objeto Timestamp
                const data = dataString.toDate ? dataString.toDate() : new Date(dataString + 'T00:00:00');
                if (isNaN(data.getTime())) return 'Data inválida';
                return data.toLocaleDateString('pt-BR');
            } catch (e) {
                return 'Data inválida';
            }
        }

        function mostrarPopupAlerta(mensagem, tipo = 'info') { // tipo: 'high', 'medium', 'low', 'info'
            const popup = document.createElement('div');
            popup.classList.add('alert-popup', tipo);
            
            let iconClass = 'fa-info-circle';
            if (tipo === 'high') iconClass = 'fa-exclamation-triangle';
            else if (tipo === 'medium') iconClass = 'fa-exclamation-circle';
            else if (tipo === 'low') iconClass = 'fa-check-circle';

            popup.innerHTML = `
                <i class="fas ${iconClass}"></i>
                <div class="alert-popup-content">
                    <p>${mensagem}</p>
                </div>
                <button class="alert-popup-close">&times;</button>
            `;

            popup.querySelector('.alert-popup-close').onclick = () => {
                popup.remove();
            };

            alertPopupContainer.appendChild(popup);

            // Remover popup após alguns segundos
            setTimeout(() => {
                popup.remove();
            }, 7000); // 7 segundos
        }

        // --- Inicialização --- 
        function definirDataAtualPadrao() {
            const hoje = new Date().toISOString().split('T')[0];
            [maquinaDataAquisicao, operacaoData, pecaUltimaTroca, manutencaoData].forEach(input => {
                if (input && !input.value) {
                    input.value = hoje;
                }
            });
        }

        definirDataAtualPadrao();
        // O carregamento inicial dos dados é feito pelo onAuthStateChanged

    </script>
</body>
</html>
