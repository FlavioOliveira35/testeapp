<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Checklist - Instaladores</title>
  <style>
    :root {
      --primary: #4f46e5;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --gray: #d1d5db;
      --white: #ffffff;
      --text: #111827;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f4f6;
      color: var(--text);
    }

    header {
      background: var(--primary);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    nav {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: white;
    }

    nav button {
      flex: 1;
      padding: 1rem;
      border: none;
      background: transparent;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    nav button:hover {
      background: #f9fafb;
    }

    nav button.active::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--primary);
    }

    main {
      padding: 1rem;
    }

    .card {
      background: white;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }

    .flex-gap {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn {
      background: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn.red { background: var(--red); }
    .btn.green { background: var(--green); }
    .btn.yellow { background: var(--yellow); color: black; }
    .btn.white { background: var(--white); color: var(--text); border: 1px solid #ccc; }

    .btn:hover {
      filter: brightness(1.1);
    }

    .login-box {
      max-width: 400px;
      margin: 4rem auto;
      background: white;
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .login-box input {
      display: block;
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }

    .error {
      color: var(--red);
      margin-bottom: 1rem;
    }

    .status-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 1.25rem;
      transition: all 0.3s ease;
      background: #e5e7eb;
      color: #6b7280;
      border: none;
    }

    .status-btn.ok {
      background: var(--green);
      color: white;
    }

    .status-btn.nok {
      background: var(--red);
      color: white;
    }

    .tool-status {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .report-summary {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .summary-card {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      flex: 1;
      min-width: 150px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .summary-title {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 0.25rem;
    }

    .tech-card {
      background: white;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 1rem;
    }

    .delete-btn-wrapper {
      position: absolute;
      right: 1rem;
      top: 1rem;
    }

    .tool-card {
      background: #f9fafb;
      padding: 0.75rem;
      border-left: 4px solid var(--primary);
      margin-top: 0.5rem;
      border-radius: 0.5rem;
    }

    .tool-card.ok {
      border-left-color: var(--green);
    }

    .tool-card.nok {
      border-left-color: var(--red);
    }

    .tool-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tool-card small {
      display: block;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .tool-expired {
      color: var(--red);
      font-weight: bold;
    }

    .tool-expiring {
      color: var(--yellow);
    }

    .tool-ok-nok {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .tool-ok-nok span {
      font-size: 0.85rem;
    }

    svg.icon {
      width: 1.25rem;
      height: 1.25rem;
      vertical-align: middle;
      fill: currentColor;
    }

    .hidden {
      display: none;
    }

    .tool-details {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .tool-comment {
      font-size: 0.85rem;
      margin-top: 0.25rem;
      color: #6b7280;
    }

    .no-tools {
      text-align: center;
      color: #6b7280;
      margin-top: 1rem;
    }

    .mt-6 {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="login-screen">
    <div class="login-box">
      <h2>Login</h2>
      <p><small>E-mail: supervisor@example.com<br/>Senha: 123456</small></p>
      <input type="email" id="login-email" value="supervisor@example.com" />
      <input type="password" id="login-password" value="123456" />
      <p class="error" id="login-error"></p>
      <button onclick="handleLogin()" class="btn">Entrar</button>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none;">
    <header>
      <h1>Ferramental de Instaladores</h1>
      <button onclick="signOutUser()" class="btn">Sair</button>
    </header>

    <nav>
      <button class="active" data-tab="checklist" onclick="switchTab(this)">Checklist</button>
      <button data-tab="reports" onclick="switchTab(this)">Relatórios</button>
      <button data-tab="technicians" onclick="switchTab(this)">Técnicos</button>
    </nav>

    <main>
      <!-- Checklist Tab -->
      <section id="tab-checklist" class="tab-content active">
        <select id="tech-select" onchange="loadTools(this.value)">
          <option value="">Selecione um técnico</option>
        </select>

        <div class="flex-gap">
          <input type="text" id="new-tool-name" placeholder="Nova ferramenta" />
          <button onclick="addTool()" class="btn">Adicionar</button>
        </div>

        <div id="tools-list"></div>
      </section>

      <!-- Reports Tab -->
      <section id="tab-reports" class="tab-content hidden">
        <h2>Resumo Geral</h2>
        <div class="report-summary">
          <div class="summary-card">
            <div class="summary-title">Total de Ferramentas</div>
            <div class="summary-value" id="total-tools">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">Ferramentas OK</div>
            <div class="summary-value tool-ok" id="total-ok">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">Ferramentas NOK</div>
            <div class="summary-value tool-nok" id="total-nok">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">Próximos a Vencer</div>
            <div class="summary-value tool-expiring" id="total-expiring">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">Vencidos</div>
            <div class="summary-value tool-expired" id="total-expired">0</div>
          </div>
        </div>

        <h2 class="mt-6">Análise por Técnico</h2>
        <table class="summary-table">
          <thead>
            <tr>
              <th>Técnico</th>
              <th>OK</th>
              <th>NOK</th>
              <th>Total</th>
              <th>Vence em 7 dias</th>
              <th>Vencido</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </section>

      <!-- Technicians Tab -->
      <section id="tab-technicians" class="tab-content hidden">
        <h2>Gerenciar Técnicos</h2>
        <div class="flex-gap">
          <input type="text" id="new-tech-name" placeholder="Nome do técnico" />
          <input type="text" id="new-tech-role" placeholder="Cargo" />
          <button onclick="addTechnician()" class="btn">Adicionar</button>
        </div>
        <ul id="technicians-list"></ul>
      </section>
    </main>
  </div>

  <script>
    const mockUser = {
      email: "supervisor@example.com",
      password: "123456"
    };

    let technicians = [
      {
        id: 1,
        name: "João Silva",
        role: "Instalador Sênior",
        tools: [
          {
            id: 101,
            name: "Cabo de Fibra Óptica",
            status: "OK",
            deliveredAt: "2025-01-10",
            dueDate: "2025-04-10",
            comment: "Em bom estado.",
            history: [{ date: "2025-01-10", action: "Marcado como OK", by: "Você" }]
          },
          {
            id: 102,
            name: "Testador de Sinal",
            status: "NOK",
            deliveredAt: "",
            dueDate: "",
            comment: "",
            history: []
          }
        ]
      },
      {
        id: 2,
        name: "Carlos Mendes",
        role: "Instalador Júnior",
        tools: []
      }
    ];

    let selectedTechId = null;

    function showApp() {
      document.getElementById("app").style.display = "block";
      document.getElementById("login-screen").style.display = "none";
      loadTechnicians();
    }

    function showLogin() {
      document.getElementById("app").style.display = "none";
      document.getElementById("login-screen").style.display = "block";
    }

    function handleLogin() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;

      if (email === mockUser.email && password === mockUser.password) {
        showApp();
      } else {
        document.getElementById("login-error").innerText = "E-mail ou senha inválidos.";
      }
    }

    function signOutUser() {
      showLogin();
    }

    function switchTab(btn) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.getElementById("tab-" + btn.dataset.tab).classList.remove("hidden");
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      if (btn.dataset.tab === 'reports') updateReportSummary();
    }

    function loadTechnicians() {
      updateTechnicianList();
      populateTechSelect();
      if (!selectedTechId && technicians.length > 0) {
        selectedTechId = technicians[0].id;
        loadTools(selectedTechId);
      }
    }

    function addTechnician() {
      const name = document.getElementById("new-tech-name").value.trim();
      const role = document.getElementById("new-tech-role").value.trim();
      if (!name || !role) return;

      const tech = {
        id: Date.now(),
        name,
        role,
        tools: []
      };
      technicians.push(tech);
      updateTechnicianList();
      populateTechSelect();
      document.getElementById("new-tech-name").value = "";
      document.getElementById("new-tech-role").value = "";
    }

    function updateTechnicianList() {
      const list = document.getElementById("technicians-list");
      list.innerHTML = "";
      technicians.forEach(tech => {
        const li = document.createElement("li");
        li.className = "tech-card";

        const okCount = tech.tools.filter(t => t.status === "OK").length;
        const nokCount = tech.tools.filter(t => t.status === "NOK").length;

        li.innerHTML = `
          <strong>${tech.name}</strong> <small>${tech.role}</small>
          <div class="tool-ok-nok">
            <span class="tool-ok"><svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg> ${okCount}</span>
            <span class="tool-nok"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></svg> ${nokCount}</span>
          </div>
          <div class="delete-btn-wrapper">
            <button class="btn red" onclick="deleteTechnician(${tech.id})">Excluir</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    function deleteTechnician(id) {
      technicians = technicians.filter(t => t.id !== id);
      updateTechnicianList();
      populateTechSelect();
      if (selectedTechId === id) {
        selectedTechId = null;
        document.getElementById("tools-list").innerHTML = "";
      }
    }

    function populateTechSelect() {
      const select = document.getElementById("tech-select");
      select.innerHTML = "<option value=''>Selecione</option>";
      technicians.forEach(tech => {
        const opt = document.createElement("option");
        opt.value = tech.id;
        opt.textContent = tech.name;
        select.appendChild(opt);
      });
    }

    function loadTools(id) {
      selectedTechId = parseInt(id);
      const tech = technicians.find(t => t.id === selectedTechId);
      renderTools(tech?.tools || []);
    }

    function renderTools(tools) {
      const container = document.getElementById("tools-list");
      container.innerHTML = "";

      if (tools.length === 0) {
        container.innerHTML = "<p class='no-tools'>Nenhuma ferramenta cadastrada.</p>";
        return;
      }

      tools.forEach(tool => {
        const card = document.createElement("div");
        card.className = "tool-card " + (tool.status === "OK" ? "ok" : "nok");

        const today = new Date();
        const dueDate = tool.dueDate ? new Date(tool.dueDate) : null;
        const isOverdue = dueDate && dueDate < today;
        const isExpiring = dueDate && ((dueDate - today) / (1000 * 60 * 60 * 24)) <= 7;

        const expiredLabel = isOverdue 
          ? `<span class="tool-expired">⚠ Vencido</span>` 
          : isExpiring 
            ? `<span class="tool-expiring">⏳ Próximo ao vencimento</span>` 
            : '';

        card.innerHTML = `
          <div class="tool-card-header">
            <div>
              <div class="tool-name">${tool.name}</div>
              <small>${expiredLabel}</small>
            </div>
          </div>
          <div class="tool-ok-nok">
            <button class="status-btn ${tool.status === 'OK' ? 'ok' : ''}" onclick="updateToolStatus(${tool.id}, 'status', 'OK')">✔</button>
            <button class="status-btn ${tool.status === 'NOK' ? 'nok' : ''}" onclick="updateToolStatus(${tool.id}, 'status', 'NOK')">✘</button>
          </div>
          <div class="form-group">
            <label>Data de Entrega
              <input type="date" value="${tool.deliveredAt}" onchange="updateToolStatus(${tool.id}, 'deliveredAt', this.value)" />
            </label>
            <label>Prazo de Troca
              <input type="date" value="${tool.dueDate}" onchange="updateToolStatus(${tool.id}, 'dueDate', this.value)" />
            </label>
          </div>
        `;

        container.appendChild(card);
      });

      updateReportSummary();
    }

    function updateToolStatus(id, field, value) {
      const tech = technicians.find(t => t.id === selectedTechId);
      const tool = tech.tools.find(t => t.id === id);
      if (tool) {
        tool[field] = value;
        // Atualiza histórico
        tool.history = tool.history || [];
        tool.history.unshift({
          date: new Date().toISOString().split('T')[0],
          action: `Status alterado para ${value}`,
          by: "Você"
        });
        renderTools(tech.tools);
      }
    }

    function addTool() {
      const name = document.getElementById("new-tool-name").value.trim();
      if (!name) return;
      const tool = {
        id: Date.now(),
        name,
        status: "NOK",
        deliveredAt: "",
        dueDate: "",
        comment: "",
        history: []
      };
      const tech = technicians.find(t => t.id === selectedTechId);
      tech.tools.push(tool);
      renderTools(tech.tools);
      document.getElementById("new-tool-name").value = "";
    }

    function getStats(tools) {
      const stats = { ok: 0, nok: 0, expiring: 0, overdue: 0 };
      const today = new Date();
      tools.forEach(tool => {
        if (tool.status === "OK") stats.ok++;
        if (tool.status === "NOK") stats.nok++;
        if (tool.dueDate) {
          const due = new Date(tool.dueDate);
          const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
          if (diffDays <= 7 && diffDays >= 0) stats.expiring++;
          if (due < today) stats.overdue++;
        }
      });
      return stats;
    }

    function updateReportSummary() {
      let totalTools = 0, totalOk = 0, totalNok = 0, totalExpiring = 0, totalExpired = 0;

      const tableBody = document.getElementById("report-table-body");
      tableBody.innerHTML = "";

      technicians.forEach(tech => {
        const stats = getStats(tech.tools);
        totalTools += tech.tools.length;
        totalOk += stats.ok;
        totalNok += stats.nok;
        totalExpiring += stats.expiring;
        totalExpired += stats.overdue;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${tech.name}</td>
          <td>${stats.ok}</td>
          <td>${stats.nok}</td>
          <td>${tech.tools.length}</td>
          <td>${stats.expiring}</td>
          <td>${stats.overdue}</td>
          <td><button class="btn yellow" onclick="toggleDetails(${tech.id})">Detalhes</button></td>
        `;
        tableBody.appendChild(tr);

        const detailsRow = document.createElement("tr");
        detailsRow.style.display = "none";
        detailsRow.innerHTML = `<td colspan="6" class="details-cell"></td>`;
        tableBody.appendChild(detailsRow);
      });

      document.getElementById("total-tools").textContent = totalTools;
      document.getElementById("total-ok").textContent = totalOk;
      document.getElementById("total-nok").textContent = totalNok;
      document.getElementById("total-expiring").textContent = totalExpiring;
      document.getElementById("total-expired").textContent = totalExpired;
    }

    function toggleDetails(techId) {
      const rows = document.querySelectorAll(`tr`);
      rows.forEach(row => {
        const cell = row.querySelector("td");
        if (cell?.innerText.includes(technicians.find(t => t.id === techId)?.name || '')) {
          const nextRow = row.nextElementSibling;
          if (nextRow && nextRow.querySelector("td")) {
            nextRow.style.display = nextRow.style.display === "none" ? "table-row" : "none";
            const detailCell = nextRow.querySelector("td");
            detailCell.innerHTML = "";

            const tech = technicians.find(t => t.id === techId);
            if (!tech || tech.tools.length === 0) {
              detailCell.innerText = "Nenhuma ferramenta encontrada.";
              return;
            }

            tech.tools.forEach(tool => {
              const div = document.createElement("div");
              div.className = "tool-details";
              div.innerHTML = `
                <div><strong>${tool.name}</strong> (${tool.status})</div>
                <small>Data de entrega: ${tool.deliveredAt || '-'}, Prazo: ${tool.dueDate || '-'}</small>
                <div class="tool-comment">${tool.comment || ''}</div>
              `;
              detailCell.appendChild(div);
            });
          }
        }
      });
    }

    function populateTechSelect() {
      const select = document.getElementById("tech-select");
      select.innerHTML = "<option value=''>Selecione</option>";
      technicians.forEach(tech => {
        const opt = document.createElement("option");
        opt.value = tech.id;
        opt.textContent = tech.name;
        select.appendChild(opt);
      });
    }

    function updateTechnicianList() {
      const list = document.getElementById("technicians-list");
      list.innerHTML = "";
      technicians.forEach(tech => {
        const li = document.createElement("li");
        li.className = "tech-card";

        const okCount = tech.tools.filter(t => t.status === "OK").length;
        const nokCount = tech.tools.filter(t => t.status === "NOK").length;

        li.innerHTML = `
          <strong>${tech.name}</strong> <small>${tech.role}</small>
          <div class="tool-ok-nok">
            <span class="tool-ok"><svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg> ${okCount}</span>
            <span class="tool-nok"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></svg> ${nokCount}</span>
          </div>
          <div class="delete-btn-wrapper">
            <button class="btn red" onclick="deleteTechnician(${tech.id})">Excluir</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    function addTechnician() {
      const name = document.getElementById("new-tech-name").value.trim();
      const role = document.getElementById("new-tech-role").value.trim();
      if (!name || !role) return;

      const tech = {
        id: Date.now(),
        name,
        role,
        tools: []
      };
      technicians.push(tech);
      updateTechnicianList();
      populateTechSelect();
      document.getElementById("new-tech-name").value = "";
      document.getElementById("new-tech-role").value = "";
    }

    function addTool() {
      const name = document.getElementById("new-tool-name").value.trim();
      if (!name) return;
      const tool = {
        id: Date.now(),
        name,
        status: "NOK",
        deliveredAt: "",
        dueDate: "",
        comment: "",
        history: []
      };
      const tech = technicians.find(t => t.id === selectedTechId);
      tech.tools.push(tool);
      renderTools(tech.tools);
      document.getElementById("new-tool-name").value = "";
    }

    function loadTools(id) {
      selectedTechId = id;
      const tech = technicians.find(t => t.id === parseInt(id));
      renderTools(tech?.tools || []);
    }

    function updateToolStatus(id, field, value) {
      const tech = technicians.find(t => t.id === selectedTechId);
      const tool = tech.tools.find(t => t.id === id);
      if (tool) {
        tool[field] = value;
        renderTools(tech.tools);
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.getElementById("tab-" + tabName).classList.remove("hidden");
    }

    window.onload = () => {
      const saved = localStorage.getItem("technicians");
      if (saved) technicians = JSON.parse(saved);
      showLogin();
    };
  </script>
</body>
</html>
